# 局域网使用指南

## 📋 概述

系统已配置为支持局域网访问，其他设备可以通过局域网 IP 访问抽签系统。

## 🔧 配置说明

### 后端配置

**监听地址**：`http://0.0.0.0:5000`
- `0.0.0.0` 表示监听所有网络接口
- 可以通过 localhost、127.0.0.1、局域网IP 访问

**CORS 配置**：
- 开发环境：允许所有来源（`AllowAnyOrigin`）
- 支持局域网内任意设备访问

## 🚀 使用步骤

### 1. 获取本机 IP 地址

**方法一：使用命令行**
```bash
ipconfig
```

查找 "IPv4 地址"，例如：
```
IPv4 地址 . . . . . . . . . . . . : 192.168.1.100
```

**方法二：使用 PowerShell**
```powershell
Get-NetIPAddress -AddressFamily IPv4 | Where-Object {$_.IPAddress -like "192.168.*"} | Select-Object IPAddress
```

### 2. 启动后端

```bash
cd Kiro-ver/lottery-backend
dotnet run
```

**确认监听地址**：
```
Now listening on: http://0.0.0.0:5000
```

### 3. 启动前端

**方式一：使用 Vite 开发服务器（推荐）**
```bash
cd Kiro-ver/lottery-frontend
pnpm run dev -- --host
```

这会让 Vite 监听所有网络接口，输出类似：
```
➜  Local:   http://localhost:5173/
➜  Network: http://192.168.1.100:5173/
```

**方式二：使用 http-server**
```bash
cd Kiro-ver/lottery-frontend
pnpm run build
http-server dist -p 8080
```

### 4. 访问系统

**本机访问**：
- http://localhost:5173 (Vite)
- http://localhost:8080 (http-server)

**局域网其他设备访问**：
- http://192.168.1.100:5173 (Vite)
- http://192.168.1.100:8080 (http-server)

*注意：将 `192.168.1.100` 替换为你的实际 IP 地址*

## 🔧 前端 API 地址配置

### 方案一：自动检测（推荐）

修改 `src/api/lottery.ts`：

```typescript
// 自动检测 API 地址
const getApiBase = () => {
  // 如果是通过 IP 访问，使用相同的 IP
  if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
    return `http://${window.location.hostname}:5000/api/lottery`;
  }
  // 本地访问使用 localhost
  return 'http://localhost:5000/api/lottery';
};

const API_BASE = getApiBase();
```

### 方案二：使用环境变量

创建 `.env` 文件：
```bash
# .env.development
VITE_API_BASE_URL=http://localhost:5000/api/lottery

# .env.production
VITE_API_BASE_URL=http://192.168.1.100:5000/api/lottery
```

在代码中使用：
```typescript
const API_BASE = import.meta.env.VITE_API_BASE_URL || 'http://localhost:5000/api/lottery';
```

## 📱 移动设备访问

### 1. 确保在同一局域网

- 手机/平板连接到与电脑相同的 WiFi
- 确认可以 ping 通电脑 IP

### 2. 访问地址

在移动设备浏览器中输入：
```
http://192.168.1.100:5173
```

### 3. 测试连接

在移动设备浏览器中访问：
```
http://192.168.1.100:5000/api/lottery/stats
```

应该能看到 JSON 数据。

## 🔥 防火墙配置

### Windows 防火墙

如果无法访问，需要允许端口通过防火墙：

**方法一：使用 PowerShell（管理员权限）**
```powershell
# 允许 5000 端口（后端）
New-NetFirewallRule -DisplayName "抽签系统后端" -Direction Inbound -LocalPort 5000 -Protocol TCP -Action Allow

# 允许 5173 端口（前端 Vite）
New-NetFirewallRule -DisplayName "抽签系统前端" -Direction Inbound -LocalPort 5173 -Protocol TCP -Action Allow

# 允许 8080 端口（前端 http-server）
New-NetFirewallRule -DisplayName "抽签系统前端HTTP" -Direction Inbound -LocalPort 8080 -Protocol TCP -Action Allow
```

**方法二：使用图形界面**
1. 打开 Windows 防火墙设置
2. 点击"高级设置"
3. 点击"入站规则" → "新建规则"
4. 选择"端口" → "TCP"
5. 输入端口号：5000, 5173, 8080
6. 选择"允许连接"
7. 完成

## 🧪 测试局域网访问

### 1. 测试后端 API

在其他设备的浏览器中访问：
```
http://192.168.1.100:5000/api/lottery/stats
```

应该能看到 JSON 统计数据。

### 2. 测试前端页面

在其他设备的浏览器中访问：
```
http://192.168.1.100:5173
```

应该能看到抽签系统界面。

### 3. 测试完整功能

- 点击"开始抽签"按钮
- 查看是否能正常抽签
- 测试筛选功能

## 📝 启动脚本更新

### 后端启动脚本（已自动配置）

`start-backend.bat` 会自动使用 `0.0.0.0:5000`

### 前端启动脚本（支持局域网）

创建 `start-frontend-lan.bat`：
```batch
@echo off
echo 正在启动抽签系统前端（局域网模式）...
cd lottery-frontend
pnpm run dev -- --host
```

## 🌐 获取本机 IP 的快捷方式

创建 `get-ip.bat`：
```batch
@echo off
echo ========================================
echo 本机 IP 地址
echo ========================================
ipconfig | findstr "IPv4"
echo.
echo ========================================
echo 访问地址：
echo 后端 API: http://你的IP:5000
echo 前端页面: http://你的IP:5173
echo ========================================
pause
```

## ⚠️ 注意事项

### 1. 网络安全

- 开发环境允许所有来源访问（方便开发）
- 生产环境必须配置具体的域名白名单
- 不要在公网环境使用 `AllowAnyOrigin`

### 2. 性能考虑

- 局域网访问速度取决于网络质量
- 建议使用有线网络或 5G WiFi
- 避免多人同时大量请求

### 3. 数据库访问

- 数据库文件在服务器本地
- 所有设备共享同一个数据库
- 数据修改会立即对所有用户生效

### 4. 端口占用

确保以下端口未被占用：
- 5000 - 后端 API
- 5173 - 前端 Vite（或 8080 http-server）

## 🔍 故障排查

### 问题1：无法访问后端 API

**检查清单**：
- [ ] 后端是否正常运行
- [ ] 监听地址是否为 `0.0.0.0:5000`
- [ ] 防火墙是否允许 5000 端口
- [ ] 设备是否在同一局域网
- [ ] IP 地址是否正确

**测试命令**：
```bash
# 在其他设备上测试
curl http://192.168.1.100:5000/api/lottery/stats
```

### 问题2：前端无法连接后端

**检查清单**：
- [ ] 前端 API 地址配置是否正确
- [ ] 浏览器控制台是否有 CORS 错误
- [ ] 后端 CORS 配置是否正确

**解决方案**：
1. 检查浏览器控制台的错误信息
2. 确认后端日志中的 CORS 信息
3. 使用 Swagger UI 测试 API

### 问题3：防火墙阻止

**症状**：
- 本机可以访问
- 其他设备无法访问

**解决方案**：
1. 临时关闭防火墙测试
2. 如果可以访问，说明是防火墙问题
3. 添加防火墙规则允许端口

## 📊 网络拓扑

```
┌─────────────────────────────────────────┐
│         局域网 (192.168.1.x)             │
│                                         │
│  ┌──────────────┐                      │
│  │  服务器电脑   │                      │
│  │  192.168.1.100│                     │
│  │              │                      │
│  │  后端: :5000 │                      │
│  │  前端: :5173 │                      │
│  └──────────────┘                      │
│         │                               │
│         │ 局域网                        │
│         │                               │
│  ┌──────┴───────┬──────────┬─────────┐ │
│  │              │          │         │ │
│  ▼              ▼          ▼         ▼ │
│ 电脑1         电脑2      手机1     平板1│
│ .101          .102       .103      .104│
└─────────────────────────────────────────┘
```

## 🎯 使用场景

### 课堂使用

1. **教师电脑**（服务器）
   - 运行后端和前端
   - IP: 192.168.1.100

2. **投影仪/大屏**
   - 访问 http://192.168.1.100:5173
   - 显示抽签界面

3. **学生设备**
   - 可以查看抽签结果
   - 可以查看统计信息

### 活动使用

1. **主持人设备**
   - 运行系统
   - 控制抽签

2. **观众设备**
   - 实时查看结果
   - 同步显示

## 📝 快速参考

### 启动命令

```bash
# 后端（自动监听 0.0.0.0:5000）
./start-backend.bat

# 前端（局域网模式）
cd lottery-frontend
pnpm run dev -- --host
```

### 访问地址

```
本机访问：
- 前端: http://localhost:5173
- 后端: http://localhost:5000

局域网访问：
- 前端: http://你的IP:5173
- 后端: http://你的IP:5000
```

### 获取 IP

```bash
ipconfig | findstr "IPv4"
```

---

**更新时间**：2025-12-06  
**配置状态**：✅ 已完成
