# 局域网访问问题修复

## 问题描述

在手机或其他设备上访问前端页面时，虽然页面能正常显示，但会出现 "Failed to fetch" 错误，无法获取数据。

## 问题原因

前端代码中 API 地址硬编码为 `http://localhost:5000`，导致：

- ✅ 在电脑上访问 `http://localhost:5173` → 前端调用 `http://localhost:5000` → **正常**
- ❌ 在手机上访问 `http://192.168.1.100:5173` → 前端调用 `http://localhost:5000` → **失败**

手机上的 `localhost` 指向手机自己，而不是电脑，所以无法访问到后端 API。

## 解决方案

修改 `lottery-frontend/src/api/lottery.ts`，让 API 地址自动适配当前访问的主机：

```typescript
// 修改前
const API_BASE = 'http://localhost:5000/api/lottery';

// 修改后
const getApiBase = () => {
  const hostname = window.location.hostname;
  return `http://${hostname}:5000/api/lottery`;
};

const API_BASE = getApiBase();
```

## 工作原理

前端会自动检测当前访问的主机名，并使用相同的主机名访问后端：

| 访问方式 | 前端地址 | 后端 API 地址 | 结果 |
|---------|---------|--------------|------|
| 本机访问 | `http://localhost:5173` | `http://localhost:5000` | ✅ 正常 |
| 局域网访问 | `http://192.168.1.100:5173` | `http://192.168.1.100:5000` | ✅ 正常 |
| 手机访问 | `http://192.168.1.100:5173` | `http://192.168.1.100:5000` | ✅ 正常 |

## 使用步骤

1. **重新启动前端**（应用新的配置）：
   ```bash
   # 停止当前运行的前端（Ctrl+C）
   # 重新启动
   ./start-frontend-lan.bat
   ```

2. **获取电脑 IP 地址**：
   ```bash
   ./get-ip.bat
   ```

3. **在手机上访问**：
   - 确保手机和电脑连接同一 WiFi
   - 在手机浏览器输入：`http://你的IP:5173`
   - 例如：`http://192.168.1.100:5173`

## 验证方法

### 在电脑上测试
1. 打开浏览器访问 `http://localhost:5173`
2. 点击"开始抽签"按钮
3. 应该能正常显示学生信息

### 在手机上测试
1. 确保后端和前端都在运行
2. 在手机浏览器访问 `http://你的IP:5173`
3. 点击"开始抽签"按钮
4. 应该能正常显示学生信息

## 常见问题

### Q: 手机还是显示 "Failed to fetch"？

**检查清单：**

1. ✅ **后端是否正在运行？**
   ```bash
   netstat -an | findstr :5000
   ```
   应该显示：`TCP    0.0.0.0:5000           0.0.0.0:0              LISTENING`

2. ✅ **前端是否重新启动？**
   - 必须停止旧的前端进程
   - 使用 `start-frontend-lan.bat` 重新启动

3. ✅ **防火墙是否允许 5000 端口？**
   - Windows 防火墙可能阻止外部访问
   - 参考《局域网使用指南.md》配置防火墙

4. ✅ **手机和电脑在同一网络？**
   - 必须连接同一个 WiFi
   - 不能使用移动数据

5. ✅ **IP 地址是否正确？**
   - 使用 `get-ip.bat` 获取正确的 IP
   - 不要使用 `127.0.0.1` 或 `localhost`

### Q: 在电脑上访问正常，手机上不行？

这通常是防火墙问题。解决方法：

1. **临时关闭防火墙测试**（不推荐长期使用）
2. **添加防火墙规则**（推荐）：
   ```bash
   # 以管理员身份运行 PowerShell
   New-NetFirewallRule -DisplayName "抽签系统-后端" -Direction Inbound -LocalPort 5000 -Protocol TCP -Action Allow
   New-NetFirewallRule -DisplayName "抽签系统-前端" -Direction Inbound -LocalPort 5173 -Protocol TCP -Action Allow
   ```

### Q: 可以使用域名吗？

可以！如果你配置了本地域名解析（如 `lottery.local`），系统会自动使用该域名访问后端。

## 技术说明

### 为什么不使用环境变量？

环境变量方案需要：
- 开发环境配置 `.env.development`
- 生产环境配置 `.env.production`
- 用户需要手动修改配置

自动检测方案：
- ✅ 无需配置
- ✅ 自动适配
- ✅ 开发和生产环境通用

### 安全性考虑

当前方案适用于：
- ✅ 局域网内部使用
- ✅ 开发和测试环境
- ✅ 教室、办公室等可信网络

如果需要部署到公网，建议：
- 使用 HTTPS
- 配置环境变量
- 添加身份验证
- 使用反向代理（如 Nginx）

## 相关文档

- [局域网使用指南](./局域网使用指南.md)
- [CORS问题解决方案](./CORS问题解决方案.md)
- [测试和部署指南](./测试和部署指南.md)

## 更新日志

- **2024-12-06**: 修复局域网访问 API 失败问题
- **2024-12-06**: 添加自动主机名检测功能
