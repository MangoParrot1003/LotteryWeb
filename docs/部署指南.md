# 📦 抽签系统部署指南

## 开发环境部署（当前）

### 当前状态
✅ 后端已创建并测试通过
✅ 前端已创建并配置完成
✅ 数据库连接正常
✅ API 接口工作正常

### 启动方式

#### 方式一：使用批处理脚本（推荐）
1. 双击 `start-backend.bat` 启动后端
2. 双击 `start-frontend.bat` 启动前端
3. 浏览器访问 http://localhost:5173

#### 方式二：命令行启动
```bash
# 终端1 - 启动后端
cd lottery-backend
dotnet run

# 终端2 - 启动前端
cd lottery-frontend
npm run dev
```

## 生产环境部署

### 方案一：Windows 服务器部署

#### 后端部署

1. **发布后端**
```bash
cd lottery-backend
dotnet publish -c Release -o ./publish
```

2. **部署文件**
- 将 `publish` 文件夹复制到服务器
- 将 `students.db` 复制到 publish 文件夹同级目录
- 修改 `appsettings.json` 中的数据库路径（如需要）

3. **运行后端**
```bash
cd publish
dotnet lottery-backend.dll
```

4. **配置为 Windows 服务（可选）**
使用 NSSM 或 Windows Service 将应用配置为系统服务

#### 前端部署

1. **构建前端**
```bash
cd lottery-frontend
npm run build
```

2. **部署静态文件**
- 将 `dist` 文件夹内容复制到 Web 服务器（IIS/Nginx）
- 配置服务器指向 dist 目录

3. **配置 IIS（如使用 IIS）**
- 创建新网站
- 物理路径指向 dist 文件夹
- 绑定端口（如 80 或 443）

4. **配置 Nginx（如使用 Nginx）**
```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    root /path/to/dist;
    index index.html;
    
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    location /api {
        proxy_pass http://localhost:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

### 方案二：Docker 部署

#### 创建 Dockerfile（后端）
```dockerfile
# lottery-backend/Dockerfile
FROM mcr.microsoft.com/dotnet/aspnet:8.0 AS base
WORKDIR /app
EXPOSE 5000

FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
WORKDIR /src
COPY ["lottery-backend.csproj", "./"]
RUN dotnet restore
COPY . .
RUN dotnet build -c Release -o /app/build

FROM build AS publish
RUN dotnet publish -c Release -o /app/publish

FROM base AS final
WORKDIR /app
COPY --from=publish /app/publish .
COPY ../students.db .
ENTRYPOINT ["dotnet", "lottery-backend.dll"]
```

#### 创建 Dockerfile（前端）
```dockerfile
# lottery-frontend/Dockerfile
FROM node:18 AS build
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=build /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
```

#### Docker Compose
```yaml
# docker-compose.yml
version: '3.8'

services:
  backend:
    build: ./lottery-backend
    ports:
      - "5000:5000"
    volumes:
      - ./students.db:/app/students.db
    environment:
      - ASPNETCORE_ENVIRONMENT=Production

  frontend:
    build: ./lottery-frontend
    ports:
      - "80:80"
    depends_on:
      - backend
```

运行：
```bash
docker-compose up -d
```

### 方案三：云平台部署

#### Azure 部署

**后端（Azure App Service）**
1. 创建 App Service（.NET 8.0）
2. 使用 Visual Studio 或 Azure CLI 发布
3. 上传 students.db 到 App Service 文件系统
4. 配置连接字符串

**前端（Azure Static Web Apps）**
1. 创建 Static Web App
2. 连接 GitHub 仓库（可选）
3. 配置构建命令：`npm run build`
4. 配置输出目录：`dist`

#### AWS 部署

**后端（Elastic Beanstalk）**
1. 创建 .NET 环境
2. 打包应用：`dotnet publish`
3. 上传 zip 包
4. 配置环境变量

**前端（S3 + CloudFront）**
1. 创建 S3 存储桶
2. 上传 dist 文件夹内容
3. 配置静态网站托管
4. 创建 CloudFront 分发

## 配置修改

### 修改后端端口
编辑 `lottery-backend/Properties/launchSettings.json`：
```json
{
  "profiles": {
    "http": {
      "applicationUrl": "http://localhost:你的端口"
    }
  }
}
```

### 修改前端 API 地址
编辑 `lottery-frontend/src/App.vue`：
```typescript
const API_BASE = 'http://你的域名或IP:端口/api/lottery'
```

### 生产环境 CORS 配置
编辑 `lottery-backend/Program.cs`：
```csharp
builder.Services.AddCors(options =>
{
    options.AddPolicy("AllowVue", policy =>
    {
        policy.WithOrigins("http://你的前端域名")
              .AllowAnyHeader()
              .AllowAnyMethod();
    });
});
```

## 性能优化

### 后端优化
1. 启用响应压缩
2. 添加响应缓存
3. 使用连接池
4. 配置日志级别

### 前端优化
1. 启用 Gzip 压缩
2. 配置 CDN
3. 图片懒加载
4. 代码分割

### 数据库优化
1. 添加索引
```sql
CREATE INDEX idx_gender ON students(gender);
CREATE INDEX idx_class ON students(class);
```

2. 定期备份
```bash
# 备份数据库
copy students.db students_backup_20251206.db
```

## 安全建议

1. **HTTPS 配置**
   - 生产环境必须使用 HTTPS
   - 配置 SSL 证书（Let's Encrypt 免费）

2. **API 安全**
   - 添加 API 密钥验证
   - 实现请求频率限制
   - 添加输入验证

3. **数据库安全**
   - 定期备份
   - 限制文件访问权限
   - 考虑加密敏感数据

4. **防火墙配置**
   - 只开放必要端口
   - 配置 IP 白名单（如需要）

## 监控和日志

### 后端日志
配置 `appsettings.json`：
```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  }
}
```

### 前端错误监控
集成 Sentry 或其他错误追踪服务

### 性能监控
- Application Insights（Azure）
- CloudWatch（AWS）
- 自定义监控脚本

## 备份策略

### 数据库备份
```bash
# 每日备份脚本
@echo off
set date=%date:~0,4%%date:~5,2%%date:~8,2%
copy students.db backup\students_%date%.db
```

### 代码备份
- 使用 Git 版本控制
- 定期推送到远程仓库
- 标记重要版本

## 故障排查

### 常见问题

1. **后端无法启动**
   - 检查端口占用
   - 验证数据库文件路径
   - 查看错误日志

2. **前端无法连接后端**
   - 检查 CORS 配置
   - 验证 API 地址
   - 检查网络连接

3. **性能问题**
   - 检查数据库查询效率
   - 监控服务器资源使用
   - 优化前端资源加载

## 维护计划

### 日常维护
- 监控系统运行状态
- 检查错误日志
- 备份数据库

### 定期维护
- 更新依赖包
- 安全补丁更新
- 性能优化

### 升级计划
- 功能扩展
- 技术栈升级
- 架构优化

---

**部署支持**：如遇部署问题，请参考各平台官方文档或联系技术支持。
